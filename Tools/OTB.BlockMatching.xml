<tool name="OTB.BlockMatching" id="otb_blockmatching" version="1.0.0">
  <description>Performs block-matching to estimate pixel-wise disparities between two images.</description>
  <requirements>
    <requirement version="3.9" type="package">python</requirement>
  </requirements>
  <version_command><![CDATA[interpreter filename.exe --version]]></version_command>
  <command><![CDATA[$__tool_directory__/Code/openapi.py isArrayio.inleft False  isArrayio.inright False  isArraymask.inleft False  isArraymask.inright False  isArraybm.initdisp.maps.hmap False  isArraybm.initdisp.maps.vmap False  output_data_io.out $output_data_io.out  output_data_io.outmask $output_data_io.outmask  name OTB.BlockMatching io.inleft $io.inleft
io.inright $io.inright
io.out $io.out
io.outmask $io.outmask
io.outmetric $io.outmetric
mask.inleft $mask.inleft
mask.inright $mask.inright
mask.nodata $mask.nodata
mask.variancet $mask.variancet
bm.metric $bm.metric
bm.metric.lp.p $bm.metric.lp.p
bm.radius $bm.radius
bm.minhd $bm.minhd
bm.maxhd $bm.maxhd
bm.minvd $bm.minvd
bm.maxvd $bm.maxvd
bm.subpixel $bm.subpixel
bm.step $bm.step
bm.startx $bm.startx
bm.starty $bm.starty
bm.medianfilter.radius $bm.medianfilter.radius
bm.medianfilter.incoherence $bm.medianfilter.incoherence
bm.initdisp $bm.initdisp
bm.initdisp.uniform.hdisp $bm.initdisp.uniform.hdisp
bm.initdisp.uniform.vdisp $bm.initdisp.uniform.vdisp
bm.initdisp.uniform.hrad $bm.initdisp.uniform.hrad
bm.initdisp.uniform.vrad $bm.initdisp.uniform.vrad
bm.initdisp.maps.hmap $bm.initdisp.maps.hmap
bm.initdisp.maps.vmap $bm.initdisp.maps.vmap
bm.initdisp.maps.hrad $bm.initdisp.maps.hrad
bm.initdisp.maps.vrad $bm.initdisp.maps.vrad
ram $ram
prefer $prefer
response $response
outputType_io.out $OutputSection_io.out.outputType_io.out
transmissionMode_io.out $OutputSection_io.out.transmissionMode_io.out
outputType_io.outmask $OutputSection_io.outmask.outputType_io.outmask
transmissionMode_io.outmask $OutputSection_io.outmask.transmissionMode_io.outmask]]></command>
  <inputs>
    <param name="io.inleft" type="data" optional="false" label="The left input image (reference).It should have the same size and same physical space as the right input. This image can be generated by GridBasedImageResampling" help="The left input image (reference).It should have the same size and same physical space as the right input. This image can be generated by GridBasedImageResampling The following data types are allowed in the txt file:  tiff, png, jpeg" format="txt"/>
    <param name="io.inright" type="data" optional="false" label="The right input (secondary).It should have the same size and same physical space as the left input. This image can be generated by GridBasedImageResampling" help="The right input (secondary).It should have the same size and same physical space as the left input. This image can be generated by GridBasedImageResampling The following data types are allowed in the txt file:  tiff, png, jpeg" format="txt"/>
    <param name="io.out" type="select" optional="false" label="An image containing the estimated disparities as well as the metric values if the option is used. If no metric is output and no sub-pixel interpolation is done, pixel type canbe a signed integer. In the other cases, floating point pixel is advised." help="An image containing the estimated disparities as well as the metric values if the option is used. If no metric is output and no sub-pixel interpolation is done, pixel type canbe a signed integer. In the other cases, floating point pixel is advised.">
      <option value="double">double</option>
      <option selected="true" value="float">float</option>
      <option value="int16">int16</option>
      <option value="int32">int32</option>
      <option value="uint16">uint16</option>
      <option value="uint8">uint8</option>
    </param>
    <param name="io.outmask" type="select" optional="true" label="An output mask image corresponding to all citerions (see masking parameters). Only required if variance threshold or nodata criterions are set. Output pixel type is unsigned 8bit by default." help="An output mask image corresponding to all citerions (see masking parameters). Only required if variance threshold or nodata criterions are set. Output pixel type is unsigned 8bit by default.">
      <option value="double">double</option>
      <option value="float">float</option>
      <option value="int16">int16</option>
      <option value="int32">int32</option>
      <option value="uint16">uint16</option>
      <option selected="true" value="uint8">uint8</option>
    </param>
    <param name="io.outmetric" type="select" optional="false" label="If enabled, the output image will have a third component with metric optimal values" help="If enabled, the output image will have a third component with metric optimal values">
      <option selected="true" value="false">false</option>
      <option value="true">true</option>
    </param>
    <param name="mask.inleft" type="data" optional="false" label="This parameter allows providing a custom mask for the left image. Block matching will be only perform on pixels inside the mask (non-zero values)." help="This parameter allows providing a custom mask for the left image. Block matching will be only perform on pixels inside the mask (non-zero values). The following data types are allowed in the txt file:  tiff, png, jpeg" format="txt"/>
    <param name="mask.inright" type="data" optional="false" label="This parameter allows providing a custom mask for the right image. Block matching will be perform only on pixels inside the mask (non-zero values)." help="This parameter allows providing a custom mask for the right image. Block matching will be perform only on pixels inside the mask (non-zero values). The following data types are allowed in the txt file:  tiff, png, jpeg" format="txt"/>
    <param name="mask.nodata" type="float" value="0" optional="true" label="This parameter allows discarding pixels whose value is equal to the user-defined no-data value." help="This parameter allows discarding pixels whose value is equal to the user-defined no-data value."/>
    <param name="mask.variancet" type="float" value="100" optional="true" label="This parameter allows discarding pixels whose local variance is too small (the size of the neighborhood is given by the radius parameter)" help="This parameter allows discarding pixels whose local variance is too small (the size of the neighborhood is given by the radius parameter)"/>
    <param name="bm.metric" type="select" optional="false" label="Metric to evaluate matching between two local windows." help="Metric to evaluate matching between two local windows.">
      <option value="lp">lp</option>
      <option value="ncc">ncc</option>
      <option selected="true" value="ssd">ssd</option>
    </param>
    <param name="bm.metric.lp.p" type="float" value="1" optional="false" label="Value of the p parameter in Lp pseudo-norm (must be positive)." help="Value of the p parameter in Lp pseudo-norm (must be positive)."/>
    <param name="bm.radius" type="integer" value="3" optional="false" label="The radius (in pixels) of blocks in Block-Matching" help="The radius (in pixels) of blocks in Block-Matching"/>
    <param name="bm.minhd" type="integer" optional="false" label="Minimum horizontal disparity to explore (can be negative)" help="Minimum horizontal disparity to explore (can be negative)"/>
    <param name="bm.maxhd" type="integer" optional="false" label="Maximum horizontal disparity to explore (can be negative)" help="Maximum horizontal disparity to explore (can be negative)"/>
    <param name="bm.minvd" type="integer" optional="false" label="Minimum vertical disparity to explore (can be negative)" help="Minimum vertical disparity to explore (can be negative)"/>
    <param name="bm.maxvd" type="integer" optional="false" label="Maximum vertical disparity to explore (can be negative)" help="Maximum vertical disparity to explore (can be negative)"/>
    <param name="bm.subpixel" type="select" optional="false" label="Estimate disparities with sub-pixel precision" help="Estimate disparities with sub-pixel precision">
      <option value="dichotomy">dichotomy</option>
      <option selected="true" value="none">none</option>
      <option value="parabolic">parabolic</option>
      <option value="triangular">triangular</option>
    </param>
    <param name="bm.step" type="integer" value="1" optional="true" label="Location step between computed disparities. Disparities will be computed every 'step' pixels in the left image (step for both rows and columns). For instance, a value of 1 corresponds to the classic dense disparity map." help="Location step between computed disparities. Disparities will be computed every 'step' pixels in the left image (step for both rows and columns). For instance, a value of 1 corresponds to the classic dense disparity map."/>
    <param name="bm.startx" type="integer" value="0" optional="true" label="X start index of the subsampled grid (wrt the input image grid). See parameter bm.step" help="X start index of the subsampled grid (wrt the input image grid). See parameter bm.step"/>
    <param name="bm.starty" type="integer" value="0" optional="true" label="Y start index of the subsampled grid (wrt the input image grid). See parameter bm.step" help="Y start index of the subsampled grid (wrt the input image grid). See parameter bm.step"/>
    <param name="bm.medianfilter.radius" type="integer" optional="true" label="Radius (in pixels) for median filter" help="Radius (in pixels) for median filter"/>
    <param name="bm.medianfilter.incoherence" type="float" optional="true" label="Incoherence threshold between original and filtered disparity" help="Incoherence threshold between original and filtered disparity"/>
    <param name="bm.initdisp" type="select" optional="false" label="bm.initdisp" help="bm.initdisp">
      <option value="maps">maps</option>
      <option selected="true" value="none">none</option>
      <option value="uniform">uniform</option>
    </param>
    <param name="bm.initdisp.uniform.hdisp" type="integer" value="0" optional="false" label="Value of the uniform horizontal disparity initial estimate (in pixels)" help="Value of the uniform horizontal disparity initial estimate (in pixels)"/>
    <param name="bm.initdisp.uniform.vdisp" type="integer" value="0" optional="false" label="Value of the uniform vertical disparity initial estimate (in pixels)" help="Value of the uniform vertical disparity initial estimate (in pixels)"/>
    <param name="bm.initdisp.uniform.hrad" type="integer" value="0" optional="false" label="Horizontal exploration radius around the initial disparity estimate (in pixels)" help="Horizontal exploration radius around the initial disparity estimate (in pixels)"/>
    <param name="bm.initdisp.uniform.vrad" type="integer" value="0" optional="false" label="Vertical exploration radius around the initial disparity estimate (in pixels)" help="Vertical exploration radius around the initial disparity estimate (in pixels)"/>
    <param name="bm.initdisp.maps.hmap" type="data" optional="false" label="Map of the initial horizontal disparities" help="Map of the initial horizontal disparities The following data types are allowed in the txt file:  tiff, png, jpeg" format="txt"/>
    <param name="bm.initdisp.maps.vmap" type="data" optional="false" label="Map of the initial vertical disparities" help="Map of the initial vertical disparities The following data types are allowed in the txt file:  tiff, png, jpeg" format="txt"/>
    <param name="bm.initdisp.maps.hrad" type="integer" value="0" optional="false" label="Horizontal exploration radius around the initial disparity estimate (in pixels)" help="Horizontal exploration radius around the initial disparity estimate (in pixels)"/>
    <param name="bm.initdisp.maps.vrad" type="integer" value="0" optional="false" label="Vertical exploration radius around the initial disparity estimate (in pixels)" help="Vertical exploration radius around the initial disparity estimate (in pixels)"/>
    <param name="ram" type="integer" value="128" optional="true" label="Available memory for processing (in MB)" help="Available memory for processing (in MB)"/>
    <param name="prefer" type="select" label="Choose the Prefer">
      <option selected="true" value="respond-async;return=representation">respond-async;return=representation</option>
      <option value="return=minimal">return=minimal</option>
      <option value="return=representation">return=representation</option>
    </param>
    <param name="response" type="select" label="Response Type" help="Choose 'raw' for raw data or 'document' for document data.">
      <option selected="true" value="document">document</option>
      <option value="raw">raw</option>
    </param>
    <section name="OutputSection_io.out" title="Select the appropriate transmission mode for the output format" expanded="true">
      <param name="outputType_io.out" type="select" label="Author did not provide help for this parameter... ">
        <option value="image/jpeg">jpeg</option>
        <option value="image/png">png</option>
        <option value="image/tiff">tiff</option>
      </param>
      <param name="transmissionMode_io.out" type="select" label="Choose the transmission mode">
        <option selected="true" value="reference">reference</option>
        <option value="value">value</option>
      </param>
    </section>
    <section name="OutputSection_io.outmask" title="Select the appropriate transmission mode for the output format" expanded="true">
      <param name="outputType_io.outmask" type="select" label="Author did not provide help for this parameter... ">
        <option value="image/jpeg">jpeg</option>
        <option value="image/png">png</option>
        <option value="image/tiff">tiff</option>
      </param>
      <param name="transmissionMode_io.outmask" type="select" label="Choose the transmission mode">
        <option selected="true" value="reference">reference</option>
        <option value="value">value</option>
      </param>
    </section>
  </inputs>
  <outputs>
    <data name="output_data_io.out" format="tiff" hidden="false">
      <change_format>
        <when input="response" format="txt" value="document"/>
        <when input="outputType_io.out" format="jpeg" value="image/jpeg"/>
        <when input="outputType_io.out" format="png" value="image/png"/>
      </change_format>
    </data>
    <data name="output_data_io.outmask" format="tiff" hidden="false">
      <change_format>
        <when input="response" format="txt" value="document"/>
        <when input="outputType_io.outmask" format="jpeg" value="image/jpeg"/>
        <when input="outputType_io.outmask" format="png" value="image/png"/>
      </change_format>
    </data>
  </outputs>
  <tests>
    <test>
      <output name="output_data" value="txt"/>
      <param name="response" value="document"/>
    </test>
  </tests>
  <help><![CDATA[This application allows one to performs block-matching to estimate pixel-wise disparities for a pair of images in epipolar geometry.This application is part of the stereovision pipeline. It can be used after having computed epipolar grids (with StereoRectificationGridGenerator) and resampled each input image into epipolar geometry (with GridBasedImageResampling).The application searches locally for the displacement between a reference image and a secondary image. The correspondence is evaluated for each pixel, based on a pair of local neighborhood windows. The displacement evaluated can be 1D (along lines) or 2D. Parameters allow setting the minimum and maximum disparities to search (both for horizontal and vertical directions). A winner-take-all approach is used to select the best match. There are different metrics implemented to evaluate the match between two local windows:  * SSD : Sum of Squared Distances  * NCC : Normalized Cross-Correlation  * Lp  : Lp pseudo normOnce the best integer disparity is found, an optional step of sub-pixel disparity estimation can be performed, with various algorithms (triangular interpolation, parabollic interpolation, dichotimic search). As post-processing, there is an optional step of median filtering on the disparities. One can chose input masks (related to the left and right input image) of pixels for which the disparity should be investigated. Additionally, two criteria can be optionally used to disable disparity investigation for some pixel: a no-data value, and a threshold on the local variance. This allows one to speed-up computation by avoiding to investigate disparities that will not be reliable anyway. For efficiency reasons, if the image of optimal metric values is desired, it will be concatenated to the output image (which will then have three bands : horizontal disparity, vertical disparity and metric value). One can split these images afterward.]]></help>
  <citations>
    <citation type="bibtex">Josh</citation>
  </citations>
</tool>
